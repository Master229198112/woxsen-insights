# üö® **DEBUGGING HIGH API CALLS - URGENT FIXES**\n\n## **The Problem**\nYour terminal shows **frequent notification API calls every few seconds**, even after implementing Smart Polling. This indicates multiple issues:\n\n1. **Multiple browser tabs/windows open**\n2. **Multiple component instances**\n3. **Old polling code still running**\n4. **Memory leaks in useEffect**\n\n## **üîç STEP 1: Use the Debug Tool**\n\n### **Access the Debug Page**\n```\nhttp://localhost:3001/debug\n```\n\n### **What to Look For:**\n1. **Start Monitoring** and watch the API calls\n2. **Check \"Last Minute\"** - should be ‚â§2 calls per minute\n3. **Look at \"API Endpoints Called\"** - identify which endpoints are hitting frequently\n4. **Test tab switching** - calls should stop when tab is hidden\n\n## **üö® STEP 2: Quick Diagnostic Tests**\n\n### **Test 1: Multiple Tabs**\n1. **Close ALL browser tabs** with your site\n2. **Open only ONE tab** with http://localhost:3001\n3. **Log in and check console logs**\n4. **Should see only 1 polling instance**\n\n### **Test 2: Component Instances**\n```javascript\n// Open browser console and run:\nconsole.log('üîç Active polling instances:', window.globalPollingInstances?.size || 0);\n```\n\n### **Test 3: Check for Old Code**\n1. **Search for `setInterval`** in your codebase\n2. **Look for `30000`** (30-second intervals)\n3. **Check if any old polling code is still running**\n\n## **üõ†Ô∏è STEP 3: Immediate Fixes**\n\n### **Fix 1: Component Cleanup**\nAdd this to NotificationBell.jsx to prevent memory leaks:\n\n```javascript\n// Add to the end of NotificationBell component\nuseEffect(() => {\n  return () => {\n    console.log('üîî [Cleanup] NotificationBell unmounting');\n    // Force cleanup any intervals\n  };\n}, []);\n```\n\n### **Fix 2: Singleton Pattern**\nEnsure only ONE notification polling instance runs:\n\n```javascript\n// In your main layout or app component\nconst [globalNotificationPolling, setGlobalNotificationPolling] = useState(false);\n\n// Only render NotificationBell if not already polling elsewhere\n{!globalNotificationPolling && <NotificationBell onMount={() => setGlobalNotificationPolling(true)} />}\n```\n\n### **Fix 3: Disable Old Polling**\nTemporarily disable smart polling to test:\n\n```javascript\n// In NotificationBell.jsx, change:\nconst { isActive, isPolling, forceUpdate, lastPollTime } = useSmartPolling(\n  fetchNotificationsCallback, \n  120000,\n  false // ‚Üê Change to false temporarily\n);\n```\n\n## **üîç STEP 4: Root Cause Analysis**\n\n### **Common Causes:**\n\n1. **Multiple Browser Windows**\n   - Each window/tab creates its own polling instance\n   - **Solution**: Close extra tabs\n\n2. **React Strict Mode**\n   - Development mode runs effects twice\n   - **Check**: Look for `<React.StrictMode>` in your app\n\n3. **Component Re-renders**\n   - NotificationBell mounting/unmounting frequently\n   - **Check**: Add console.log in component lifecycle\n\n4. **Multiple User Sessions**\n   - Different users logged in on same browser\n   - **Check**: Clear cookies and log in fresh\n\n5. **Nested Components**\n   - NotificationBell rendered in multiple places\n   - **Check**: Search codebase for `<NotificationBell`\n\n## **üß™ STEP 5: Testing Commands**\n\nRun these in your browser console:\n\n```javascript\n// 1. Check active intervals\nconsole.log('Active intervals:', window.setInterval.toString());\n\n// 2. Check fetch override\nconsole.log('Fetch modified:', window.fetch.toString().includes('monitor'));\n\n// 3. Check component instances\nconsole.log('React components:', document.querySelectorAll('[data-testid=\"notification-bell\"]').length);\n\n// 4. Check session\nconsole.log('Session data:', document.cookie);\n```\n\n## **üéØ STEP 6: Temporary Solution**\n\nIf nothing else works, implement **manual refresh only**:\n\n```javascript\n// Completely disable auto-polling in NotificationBell.jsx\nconst useSmartPolling = () => ({\n  isActive: false,\n  isPolling: false,\n  forceUpdate: fetchNotificationsCallback,\n  lastPollTime: null\n});\n```\n\nThis will stop ALL automatic polling and require manual refresh.\n\n## **üö® EXPECTED OUTCOME**\n\nAfter fixes, you should see:\n- **‚â§2 API calls per minute** when tab is active\n- **0 API calls** when tab is hidden\n- **Only 1 polling instance** in console logs\n- **No calls when logged out**\n\n## **üìû Emergency Steps**\n\n1. **Go to debug page**: http://localhost:3001/debug\n2. **Start monitoring**\n3. **Count API calls per minute**\n4. **If >5 calls/minute**: Close all tabs, open fresh tab\n5. **If still high**: Disable smart polling temporarily\n6. **Check console logs** for multiple instances\n\n**Report back with:**\n- Number of API calls per minute\n- Number of polling instances in console\n- Whether closing tabs helps\n- Any error messages in console\n\nThis will help identify the exact source of the excessive API calls! üîç"